{
  "mova_version": "3.6.0",
  "envelope_id": "env:smartlink_default_v1",
  "category": "edge_routing",
  "title": "Smartlink edge redirect",
  "summary": "Завантажує правила smartlink з KV, нормалізує контекст, обирає ціль і робить редірект з подією спостережуваності.",
  "context": {
    "link_id": "${params.id}",
    "request": {
      "headers": {
        "country": "${req.cf.country}",
        "accept_language": "${req.headers['accept-language']}",
        "user_agent": "${req.headers['user-agent']}"
      },
      "query": "${req.query}",
      "debug": "${req.query.debug}"
    }
  },
  "plan": {
    "objectives": [
      "Приняти клік по smartlink і перетворити його на нормалізований контекст.",
      "Завантажити декларативні правила (SmartlinkCore) з KV за link_id.",
      "Обрати ціль згідно з правилами й контекстом.",
      "Зробити HTTP-редірект на ціль і зафіксувати подію smartlink.redirected."
    ],
    "steps": [
      {
        "id": "load_rules",
        "title": "Завантажити правила smartlink з KV",
        "summary": "Дістає SmartlinkCore для поточного link_id з простору KV.",
        "verb": "plugin:kv_get",
        "resourceId": "res:kv_smartlink_rules",
        "with": {
          "key": "link:${context.link_id}",
          "as": "core"
        }
      },
      {
        "id": "normalize",
        "title": "Нормалізувати HTTP-контекст",
        "summary": "Перетворює заголовки та query у нормалізований контекст (country/lang/device/utm).",
        "verb": "transform",
        "with": {
          "operation": "set",
          "set": {
            "context_normalized": {
              "country": "${context.request.headers.country || 'EU'}",
              "lang": "${parse_lang(context.request.headers.accept_language)}",
              "device": "${parse_device(context.request.headers.user_agent)}",
              "utm": {
                "campaign": "${context.request.query.utm_campaign}",
                "source": "${context.request.query.utm_source}",
                "medium": "${context.request.query.utm_medium}",
                "term": "${context.request.query.utm_term}",
                "content": "${context.request.query.utm_content}"
              }
            }
          }
        }
      },
      {
        "id": "evaluate_rule",
        "title": "Обрати ціль за правилами",
        "summary": "Викликає ядро smartlink_eval для вибору цілі на основі SmartlinkCore та нормалізованого контексту.",
        "verb": "plugin:smartlink_eval",
        "with": {
          "core": "${state.load_rules.core}",
          "context": "${state.normalize.context_normalized}",
          "as": "decision"
        }
      },
      {
        "id": "redirect",
        "title": "Виконати редірект",
        "summary": "Будує кінцевий URL і відповідає 302 Redirect, або повертає JSON у debug-режимі.",
        "verb": "plugin:redirect",
        "with": {
          "target": "${state.evaluate_rule.decision.url || state.evaluate_rule.decision.target || state.load_rules.core.fallback_target}",
          "status": 302,
          "debug": "${context.request.debug}"
        }
      },
      {
        "id": "observability",
        "title": "Надіслати подію smartlink.redirected",
        "summary": "Фіксує факт редіректу з ключовими полями контексту й гілки.",
        "verb": "emit_event",
        "resourceId": "res:queue_smartlink_events",
        "with": {
          "event": "smartlink.redirected",
          "payload": {
            "link_id": "${context.link_id}",
            "country": "${state.normalize.context_normalized.country}",
            "lang": "${state.normalize.context_normalized.lang}",
            "device": "${state.normalize.context_normalized.device}",
            "target": "${state.redirect.target}",
            "branch": "${state.evaluate_rule.decision.branch || 'fallback'}",
            "duration_ms": "${metrics.duration_ms}"
          }
        }
      }
    ]
  }
}