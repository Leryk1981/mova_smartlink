# Smartlink UI v2 — Інтерфейс адміністрування

## Огляд

SPA інтерфейс Smartlink v2 надає зручний спосіб керування правилами маршрутизації для нетехнічних користувачів (маркетологів, e-commerce менеджерів).

## Основні можливості

### 1. Hero / Onboarding блок

**Призначення**: Пояснити користувачу що таке Smartlink без окремого лендингу.

**Елементи**:
- 📌 Основний заголовок: "Smartlink: одне посилання — різні цільові сторінки"
- 📝 Короткий опис
- ✅ 3 ключові переваги:
  - Розподіл трафіку за країною/мовою/пристроєм/UTM
  - Акції з обмеженим часом дії
  - A/B тестування лендингів
- 🚀 CTA кнопка (Створити/Зберегти)
- 💡 Підказка для початківців

**Responsive**: Hero коректно відображається на мобільних пристроях.

---

### 2. Структуровані блоки правил

Кожне правило розбите на **5 логічних блоків**:

#### 🟦 Блок 1: Основне про правило
- **Назва правила** (`label`)
  - Для зручності в інтерфейсі
  - Не впливає на логіку маршрутизації
- **Активність** (`enabled`)
  - Чекбокс "Правило активне"
  - За замовчуванням: увімкнено
  - При вимкненні: правило зберігається, але не використовується

#### 🟦 Блок 2: Умови спрацювання (when)
- **Країна** (`country`)
  - ISO код, напр. `DE`, `DE,AT,CH`
- **Мова** (`lang`)
  - ISO код, напр. `en`, `en,de`
- **Пристрій** (`device`)
  - mobile / tablet / desktop
- **UTM параметри** (опціонально)
  - source, campaign, medium, term, content

**Логіка**: Всі вказані умови повинні виконуватися (AND).

#### 🟦 Блок 3: Цільова сторінка (target)
- **URL цілі** (`target`)
  - Повний URL включаючи `https://`
  - **Обов'язкове поле**

#### 🟦 Блок 4: Час дії правила
- **Початок дії** (`start_at`)
  - Дата і час, з якого правило починає діяти
  - Формат: ISO 8601 (datetime-local input)
  - Опціонально
- **Кінець дії** (`end_at`)
  - Дата і час, після якого правило припиняє діяти
  - Опціонально
  
**Валідація**:
- ✅ `end_at` повинна бути пізніше за `start_at`
- ✅ Некоректні дати підсвічуються як помилка

**Приклади використання**:
- Flash sale: обидва поля заповнені
- Постійна акція з певної дати: тільки `start_at`
- Обмежена пропозиція: тільки `end_at`

#### 🟦 Блок 5: Пріоритет і розподіл трафіку
- **Пріоритет** (`priority`)
  - Числове поле (мінімум 0)
  - **Менше число = вище пріоритет**
  - За замовчуванням: 1000
  - Використовується для сортування правил
  
- **Вага трафіку** (`weight`)
  - Числове поле (мінімум 0, може бути дробове)
  - За замовчуванням: 1
  - Використовується для A/B тестування
  - Якщо кілька правил підходять — випадковий вибір пропорційно вазі

**Як це працює**:
1. Фільтруються **активні** правила (enabled=true, час дії відповідає)
2. Сортуються за **пріоритетом** (менше = вище)
3. Вибираються всі правила, що **підходять** за умовами
4. Якщо є **ваги** — випадковий вибір пропорційно вазі
5. Якщо немає ваг — вибирається перше підходяще правило

---

### 3. UX покращення

#### Help-тексти
Кожне поле має пояснення:
- Що воно робить
- Формат вводу
- Приклади значень

#### Валідація
- ✅ Перевірка дат (end > start)
- ✅ Некоректні значення підсвічуються
- ✅ Обов'язкові поля (`target`) позначені зірочкою

#### Візуальні підказки
- 📦 Кольорові блоки для різних секцій
- 🏷️ Бейджі для статусів (вимкнено, пріоритет)
- 💡 Hint-блоки з прикладами використання

#### Responsive дизайн
- Адаптивний layout для мобільних
- Читабельність на маленьких екранах
- Touch-friendly кнопки та інпути

---

## Використання

### Створення нового Smartlink

1. Відкрийте SPA: `http://localhost:3000` (dev) або `https://your-spa.pages.dev` (prod)
2. Введіть **Link ID** у верхньому полі
3. Натисніть таб **📝 Editor**
4. Заповніть **Basic Info**:
   - Purpose (опис кампанії)
   - Status (draft/active/archived)
   - Fallback Target (URL за замовчуванням)
5. Виберіть **Context Shape** (які поля використовуєте в правилах)
6. Додайте **Routing Rules**:
   - Натисніть "+ Додати правило"
   - Заповніть блоки
   - Натисніть на заголовок правила для згортання/розгортання
7. Натисніть **💾 Зберегти зміни** (у Hero або внизу форми)

### Редагування існуючого Smartlink

1. Введіть існуючий **Link ID**
2. SPA завантажить конфігурацію з API
3. Редагуйте правила
4. Збережіть зміни

### Тестування

1. Перейдіть на таб **🧪 Test**
2. Введіть тестові параметри:
   - Country
   - Language
   - Device
   - UTM parameters
3. Натисніть **Test Rules**
4. Побачите результат: який target обрано і чому

Або використовуйте публічне посилання з `?debug=1`:
```
https://your-worker.workers.dev/s/spring_sale_2026?debug=1&country=DE&device=mobile
```

---

## Приклади сценаріїв

### Сценарій 1: Flash Sale (Чорна п'ятниця)
```
Правило: black_friday_de
├─ enabled: true
├─ start_at: 2025-11-24T00:00:00
├─ end_at: 2025-11-25T23:59:59
├─ when:
│  └─ country: DE
└─ target: https://shop.com/black-friday-de
```

### Сценарій 2: A/B Тестування лендингів
```
Правило 1: landing_a
├─ enabled: true
├─ priority: 100
├─ weight: 1
├─ when:
│  └─ country: US
└─ target: https://shop.com/landing-a

Правило 2: landing_b
├─ enabled: true
├─ priority: 100
├─ weight: 1
├─ when:
│  └─ country: US
└─ target: https://shop.com/landing-b
```
→ Трафік з US розподілиться 50/50 між landing-a і landing-b

### Сценарій 3: Поступовий rollout
```
Правило 1: new_landing
├─ enabled: true
├─ priority: 100
├─ weight: 0.2  (20% трафіку)
├─ when:
│  └─ device: mobile
└─ target: https://shop.com/new-mobile

Правило 2: old_landing
├─ enabled: true
├─ priority: 100
├─ weight: 0.8  (80% трафіку)
├─ when:
│  └─ device: mobile
└─ target: https://shop.com/old-mobile
```

### Сценарій 4: Пріоритет каналів
```
Правило 1: vip_source
├─ enabled: true
├─ priority: 10  (найвищий)
├─ when:
│  └─ utm.source: vip_partner
└─ target: https://shop.com/vip

Правило 2: paid_traffic
├─ enabled: true
├─ priority: 50
├─ when:
│  └─ utm.medium: cpc
└─ target: https://shop.com/paid

Правило 3: organic
├─ enabled: true
├─ priority: 100
├─ when:
│  └─ utm.medium: organic
└─ target: https://shop.com/organic
```

---

## Backwards Compatibility

✅ Інтерфейс **сумісний з старими конфігураціями** (v1):
- При завантаженні старого JSON:
  - `enabled` вважається `true`
  - `priority`, `weight`, `start_at`, `end_at` — порожні
- При збереженні:
  - Нові поля додаються тільки якщо користувач їх змінював
  - Старі правила працюють як і раніше

---

## Технічні деталі

### Стек
- **React** 18+ з TypeScript
- **Vite** для збірки
- **CSS** без фреймворків (чистий CSS з responsive)
- **@mova/core-smartlink** для типів

### Компоненти
```
src/
├─ components/
│  ├─ Hero.tsx              // Onboarding блок
│  ├─ SmartlinkEditor.tsx   // Головний редактор
│  ├─ RulesEditor.tsx       // Редактор правил (блокова структура)
│  └─ TestPanel.tsx         // Панель тестування
├─ hooks/
│  └─ useSmartlink.ts       // API взаємодія
└─ styles/
   ├─ Hero.css              // Стилі Hero
   └─ RulesEditor.css       // Стилі блоків
```

### API Endpoints
- `GET /api/smartlinks/:id` — завантажити конфігурацію
- `PUT /api/smartlinks/:id` — зберегти конфігурацію
- `GET /s/:id?debug=1` — тестування з debug інфо

---

## Troubleshooting

### Проблема: Дати не зберігаються
**Рішення**: Переконайтеся, що формат `datetime-local` коректно конвертується в ISO 8601.

### Проблема: Правило не спрацьовує
**Перевірте**:
1. Чи `enabled: true`
2. Чи час дії відповідає (`start_at` / `end_at`)
3. Чи всі умови (`when`) виконуються
4. Чи правильний пріоритет

### Проблема: A/B тестування не працює
**Перевірте**:
1. Чи обидва правила мають **однаковий пріоритет**
2. Чи обидва правила мають **weight** > 0
3. Чи умови (`when`) **ідентичні** або підходять для одного трафіку

---

## Майбутні покращення

- 📊 Візуалізація розподілу трафіку (графіки)
- 📈 Статистика по правилах (які спрацьовують частіше)
- 🔄 Копіювання правил
- 📁 Групування правил в папки
- 🎨 Темна тема
- 🌐 Мультимова інтерфейсу (EN/UK/RU)

---

**Версія**: 2.0  
**Дата**: 2025-11-28  
**Автор**: MOVA Team

